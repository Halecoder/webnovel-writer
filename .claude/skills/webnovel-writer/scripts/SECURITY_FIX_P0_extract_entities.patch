--- extract_entities.py	(原始版本 - 存在路径遍历漏洞)
+++ extract_entities.py	(修复版本 - P0 CRITICAL 修复)
@@ -1,6 +1,7 @@
 #!/usr/bin/env python3
 """
-state.json 数据归档管理脚本
+实体提取脚本
+
 ...
 """

@@ -10,6 +11,10 @@
 from datetime import datetime
 from pathlib import Path

+# ============================================================================
+# 安全修复：导入安全工具函数（P0 CRITICAL）
+# ============================================================================
+from security_utils import sanitize_filename, create_secure_directory
+
 # Windows UTF-8 编码修复
 if sys.platform == 'win32':
     import io
@@ -315,10 +320,19 @@
     if entity_type == "角色":
         category = categorize_character(entity['desc'])
         category_dir = ROLE_CATEGORY_MAP.get(category.split('/')[0], "次要角色")

         target_dir = Path(project_root) / f"设定集/角色库/{category_dir}"
-        target_dir.mkdir(parents=True, exist_ok=True)
+        # ============================================================================
+        # 安全修复：使用安全目录创建函数（文件权限修复）
+        # ============================================================================
+        create_secure_directory(str(target_dir))

-        target_file = target_dir / f"{entity_name}.md"
+        # ============================================================================
+        # 安全修复：清理文件名，防止路径遍历 (CWE-22) - P0 CRITICAL
+        # 原代码: target_file = target_dir / f"{entity_name}.md"
+        # 漏洞: entity_name可能包含 "../" 导致目录遍历攻击
+        # ============================================================================
+        safe_entity_name = sanitize_filename(entity_name)
+        target_file = target_dir / f"{safe_entity_name}.md"

         if target_file.exists():
             print(f"⚠️  角色卡已存在: {target_file}")
@@ -355,10 +369,16 @@

     elif entity_type == "物品":
         target_dir = Path(project_root) / "设定集/物品库"
-        target_dir.mkdir(parents=True, exist_ok=True)
+        # ============================================================================
+        # 安全修复：使用安全目录创建函数（文件权限修复）
+        # ============================================================================
+        create_secure_directory(str(target_dir))

-        target_file = target_dir / f"{entity_name}.md"
+        # ============================================================================
+        # 安全修复：清理文件名，防止路径遍历 (CWE-22) - P0 CRITICAL
+        # ============================================================================
+        safe_entity_name = sanitize_filename(entity_name)
+        target_file = target_dir / f"{safe_entity_name}.md"

         if target_file.exists():
             print(f"⚠️  物品卡已存在: {target_file}")

## ============================================================================
## 补丁应用说明
## ============================================================================
##
## 此补丁修复了 extract_entities.py 中的 P0 CRITICAL 路径遍历漏洞
##
## 修复内容:
## 1. 导入安全工具函数 (security_utils.py)
## 2. 使用 sanitize_filename() 清理 entity_name (lines 322, 359)
## 3. 使用 create_secure_directory() 替换 mkdir() (lines 320, 356)
##
## 应用方法:
## 方法1: 手动应用
##   1. 打开 extract_entities.py
##   2. 在文件顶部导入: from security_utils import sanitize_filename, create_secure_directory
##   3. 在 line 322 之前添加: safe_entity_name = sanitize_filename(entity_name)
##   4. 修改 line 322 为: target_file = target_dir / f"{safe_entity_name}.md"
##   5. 在 line 359 之前添加: safe_entity_name = sanitize_filename(entity_name)
##   6. 修改 line 359 为: target_file = target_dir / f"{safe_entity_name}.md"
##   7. 修改 line 320 为: create_secure_directory(str(target_dir))
##   8. 修改 line 356 为: create_secure_directory(str(target_dir))
##
## 方法2: 使用 patch 命令（Linux/macOS）
##   cd .claude/skills/webnovel-writer/scripts
##   patch -p0 < SECURITY_FIX_P0_extract_entities.patch
##
## 验证修复:
##   python security_utils.py  # 运行自检测试
##   python extract_entities.py --help  # 确认脚本正常运行
##
## 安全测试:
##   创建测试文件包含恶意实体名: [NEW_ENTITY: 角色, ../../../tmp/test, 测试]
##   运行脚本后检查文件是否创建在 设定集/角色库/ 目录内（而非 /tmp/）
##
## ============================================================================
