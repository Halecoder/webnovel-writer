--- backup_manager.py	(原始版本 - 存在命令注入漏洞)
+++ backup_manager.py	(修复版本 - P1 MEDIUM 修复)
@@ -10,6 +10,10 @@
 from datetime import datetime
 from pathlib import Path

+# ============================================================================
+# 安全修复：导入安全工具函数（P1 MEDIUM）
+# ============================================================================
+from security_utils import sanitize_commit_message
+
 # Windows UTF-8 编码修复
 if sys.platform == 'win32':
     import io
@@ -165,8 +169,18 @@
             return False

         # Step 2: git commit
+        # ============================================================================
+        # 安全修复：清理提交消息，防止命令注入 (CWE-77) - P1 MEDIUM
+        # 原代码:
+        #   commit_message = f"Chapter {chapter_num}"
+        #   if chapter_title:
+        #       commit_message += f": {chapter_title}"  # 未清理的用户输入
+        # 漏洞: chapter_title可能包含换行符、Git标志（--amend等）导致命令注入
+        # ============================================================================
         commit_message = f"Chapter {chapter_num}"
         if chapter_title:
+            # 安全修复：清理章节标题，移除Git危险参数
+            safe_chapter_title = sanitize_commit_message(chapter_title)
-            commit_message += f": {chapter_title}"
+            commit_message += f": {safe_chapter_title}"

         success, output = self._run_git_command(

## ============================================================================
## 补丁应用说明
## ============================================================================
##
## 此补丁修复了 backup_manager.py 中的 P1 MEDIUM 命令注入漏洞
##
## 修复内容:
## 1. 导入安全工具函数 (security_utils.py)
## 2. 使用 sanitize_commit_message() 清理 chapter_title (line 170)
##
## 应用方法:
## 方法1: 手动应用
##   1. 打开 backup_manager.py
##   2. 在文件顶部导入: from security_utils import sanitize_commit_message
##   3. 在 line 170 之前添加: safe_chapter_title = sanitize_commit_message(chapter_title)
##   4. 修改 line 170 为: commit_message += f": {safe_chapter_title}"
##
## 方法2: 使用 patch 命令（Linux/macOS）
##   cd .claude/skills/webnovel-writer/scripts
##   patch -p0 < SECURITY_FIX_P1_backup_manager.patch
##
## 验证修复:
##   python security_utils.py  # 运行自检测试
##   python backup_manager.py --backup 1 --chapter-title "Test Chapter"  # 确认脚本正常运行
##
## 安全测试:
##   测试用例1（换行符注入）:
##     chapter_title = "Chapter 1\n--author='Attacker <attacker@evil.com>'"
##     预期: 换行符被移除，--author 标志被过滤
##
##   测试用例2（--amend注入）:
##     chapter_title = "--amend Important Chapter"
##     预期: --amend 被移除，仅保留 "Important Chapter"
##
##   测试用例3（引号注入）:
##     chapter_title = "Chapter'; rm -rf /; echo 'hacked"
##     预期: 引号被移除，无法逃逸出参数
##
## ============================================================================
