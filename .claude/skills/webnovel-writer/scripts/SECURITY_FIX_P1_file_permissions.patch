## ============================================================================
## 安全修复补丁：文件权限配置缺失 (CWE-732) - P1 MEDIUM
## ============================================================================
##
## 漏洞描述:
##   5个脚本创建目录时未设置安全权限，导致使用OS默认权限（通常为755）
##   风险：同组用户或其他用户可能读取敏感数据（state.json、review报告等）
##
## 修复方案:
##   使用 create_secure_directory() 替换 mkdir()，强制设置权限为 0o700
##
## 涉及文件（5个）:
##   1. archive_manager.py:63
##   2. extract_entities.py:320, 356
##   3. structured_index.py:64
##   4. update_state.py:122
##   5. workflow_manager.py:365
##
## ============================================================================

--- archive_manager.py	(原始版本)
+++ archive_manager.py	(修复版本)
@@ -10,6 +10,10 @@
 from datetime import datetime
 from pathlib import Path

+# ============================================================================
+# 安全修复：导入安全工具函数（P1 MEDIUM）
+# ============================================================================
+from security_utils import create_secure_directory
+
 # Windows UTF-8 编码修复
 if sys.platform == 'win32':
     import io
@@ -60,7 +64,13 @@
         self.archive_dir = project_root / ".webnovel" / "archive"

         # 确保归档目录存在
-        self.archive_dir.mkdir(parents=True, exist_ok=True)
+        # ============================================================================
+        # 安全修复：使用安全目录创建函数（P1 MEDIUM）
+        # 原代码: self.archive_dir.mkdir(parents=True, exist_ok=True)
+        # 漏洞: 未设置权限，使用OS默认（可能为755，允许同组用户读取）
+        # ============================================================================
+        create_secure_directory(str(self.archive_dir))
+

--- extract_entities.py	(原始版本 - 已在P0补丁中修复)
+++ extract_entities.py	(修复版本 - P0+P1综合修复)
## 注意：此文件已在 SECURITY_FIX_P0_extract_entities.patch 中添加
## create_secure_directory 导入和调用，无需重复修复

--- structured_index.py	(原始版本)
+++ structured_index.py	(修复版本)
@@ -10,6 +11,10 @@
 from datetime import datetime
 from pathlib import Path

+# ============================================================================
+# 安全修复：导入安全工具函数（P1 MEDIUM）
+# ============================================================================
+from security_utils import create_secure_directory
+
 class StructuredIndex:
     \"\"\"结构化索引系统 - 提供O(log n)查询性能\"\"\"

@@ -61,7 +66,13 @@
         # 数据库路径
         self.db_path = project_root / \".webnovel\" / \"index.db\"

         # 确保目录存在
-        self.db_path.parent.mkdir(parents=True, exist_ok=True)
+        # ============================================================================
+        # 安全修复：使用安全目录创建函数（P1 MEDIUM）
+        # 原代码: self.db_path.parent.mkdir(parents=True, exist_ok=True)
+        # 漏洞: 未设置权限，使用OS默认（可能为755，允许同组用户读取）
+        # ============================================================================
+        create_secure_directory(str(self.db_path.parent))
+

--- update_state.py	(原始版本)
+++ update_state.py	(修复版本)
@@ -10,6 +11,10 @@
 from datetime import datetime
 from pathlib import Path

+# ============================================================================
+# 安全修复：导入安全工具函数（P1 MEDIUM）
+# ============================================================================
+from security_utils import create_secure_directory
+
 # Windows UTF-8 编码修复
 if sys.platform == 'win32':
     import io
@@ -119,7 +124,13 @@
     def backup(self) -> bool:
         \"\"\"备份当前 state.json\"\"\"
         timestamp = datetime.now().strftime(\"%Y%m%d_%H%M%S\")
         backup_dir = Path(self.state_file).parent / \"backups\"
-        backup_dir.mkdir(exist_ok=True)
+        # ============================================================================
+        # 安全修复：使用安全目录创建函数（P1 MEDIUM）
+        # 原代码: backup_dir.mkdir(exist_ok=True)
+        # 漏洞: 未设置权限，使用OS默认（可能为755，允许同组用户读取）
+        # ============================================================================
+        create_secure_directory(str(backup_dir))
+

--- workflow_manager.py	(原始版本)
+++ workflow_manager.py	(修复版本)
@@ -10,6 +11,10 @@
 from datetime import datetime
 from pathlib import Path

+# ============================================================================
+# 安全修复：导入安全工具函数（P1 MEDIUM）
+# ============================================================================
+from security_utils import create_secure_directory
+
 # Windows UTF-8 编码修复
 if sys.platform == 'win32':
     import io
@@ -362,7 +367,13 @@

 def save_state(state):
     \"\"\"保存workflow状态\"\"\"
-    os.makedirs(os.path.dirname(WORKFLOW_STATE_FILE), exist_ok=True)
+    # ============================================================================
+    # 安全修复：使用安全目录创建函数（P1 MEDIUM）
+    # 原代码: os.makedirs(os.path.dirname(WORKFLOW_STATE_FILE), exist_ok=True)
+    # 漏洞: 未设置权限，使用OS默认（可能为755，允许同组用户读取）
+    # ============================================================================
+    create_secure_directory(os.path.dirname(WORKFLOW_STATE_FILE))
+
     with open(WORKFLOW_STATE_FILE, 'w', encoding='utf-8') as f:
         json.dump(state, f, ensure_ascii=False, indent=2)

## ============================================================================
## 补丁应用说明
## ============================================================================
##
## 此补丁修复了 5 个脚本中的 P1 MEDIUM 文件权限漏洞
##
## 修复内容:
## 1. 在每个脚本顶部导入: from security_utils import create_secure_directory
## 2. 替换所有 mkdir() / makedirs() 调用为 create_secure_directory()
##
## 应用方法:
## 方法1: 手动应用（推荐 - 更可控）
##   对于每个文件，按照补丁中的修改点逐一修复：
##
##   1. archive_manager.py (1处修复)
##      - 添加导入: from security_utils import create_secure_directory
##      - Line 63: 替换为 create_secure_directory(str(self.archive_dir))
##
##   2. extract_entities.py (0处 - 已在P0补丁中修复)
##      - 跳过（P0补丁已包含此修复）
##
##   3. structured_index.py (1处修复)
##      - 添加导入: from security_utils import create_secure_directory
##      - Line 64: 替换为 create_secure_directory(str(self.db_path.parent))
##
##   4. update_state.py (1处修复)
##      - 添加导入: from security_utils import create_secure_directory
##      - Line 122: 替换为 create_secure_directory(str(backup_dir))
##
##   5. workflow_manager.py (1处修复)
##      - 添加导入: from security_utils import create_secure_directory
##      - Line 365: 替换为 create_secure_directory(os.path.dirname(WORKFLOW_STATE_FILE))
##
## 方法2: 使用 patch 命令（Linux/macOS - 高级用户）
##   注意：此补丁涉及多个文件，建议逐个应用
##   cd .claude/skills/webnovel-writer/scripts
##   # 手动提取每个文件的diff部分，逐个应用
##
## 验证修复:
##   1. 运行 python security_utils.py  # 自检通过
##   2. 删除 .webnovel/ 目录
##   3. 运行任一脚本（例如 python update_state.py --help）
##   4. 检查权限: ls -la .webnovel/  # Unix系统
##      预期输出: drwx------ (700) .webnovel/
##   5. Windows系统: 使用 icacls .webnovel 检查权限
##
## 安全测试:
##   测试用例1（多用户环境）:
##     创建.webnovel目录 → 切换到其他用户 → 尝试读取state.json
##     预期: Permission denied (Unix/Linux/macOS)
##
##   测试用例2（权限验证）:
##     stat -c '%a' .webnovel  # Unix系统
##     预期输出: 700
##
## ============================================================================
